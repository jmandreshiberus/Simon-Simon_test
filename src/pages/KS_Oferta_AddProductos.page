<apex:page standardController="Opportunity" extensions="KS_Oferta_AddProductos_Controller,KS_Oferta_Utils" 
           docType="html-5.0" id="oferta_prod_page" standardStylesheets="true" showHeader="false" sidebar="false"
           title="{!$Label.ks_btn_edit} {!oferta.Name}">
    
    <apex:includeScript value="{!URLFOR($Resource.oferta_addProductos, 'jquery.min.js')}"/>
    <apex:includeScript value="{!URLFOR($Resource.oferta_addProductos, 'jquery-ui.min.js')}"/>
    <apex:includeScript value="{!URLFOR($Resource.oferta_addProductos, 'jquery.ui.touch-punch.min.js')}"/>
    <apex:stylesheet value="{!URLFOR($Resource.oferta_addProductos, 'css/font-awesome.min.css')}"/>
    
    <script type="text/javascript">
    function setCampoValor(idLinea, campo, objeto, ficha) {
        callRemoteSetCampo(idLinea, campo, objeto, $(objeto).prop('value'), ficha);
    }
    function setCampoValorCheck(idLinea, campo, objeto, ficha) {
        callRemoteSetCampo(idLinea, campo, objeto, $(objeto).is(':checked'), ficha);
    }
    function callRemoteSetCampo(idLinea, campo, objeto, valor, ficha) {

        $('#error-remote').hide(); $('#error-remote-text').html('');
        if (campo != 'KS_Prescrito__c' && campo != 'KS_Destinatario__c') { 
            if (valor == null || valor == 'null') {return;}
            valor = valor.trim(); 
            if (valor == '') {return;}
        }

        Visualforce.remoting.Manager.invokeAction(
            '{!$RemoteAction.KS_Oferta_Utils.callSetValorLinea}',
            idLinea,
            campo,
            valor,
            ficha,
            '{!oferta.ID}',
            function(result, event) {

                if (result != 'null' && !result.includes("KSEVERYTHINGISFINE")) {
                    
                    if (result.includes("_EXCEPTION"))
                    { result = result.split('_EXCEPTION,')[1].split(': [')[0]; }
                    if (!result.includes("## ERROR ##"))
                    { result = '## ERROR ## ' + result; }
                    
                    $('#error-remote-text').html(result);
                    $('#error-remote-text').show();
                    $('#error-remote').show();
                    
                    $('.savedMessage').each(function() {
                        $(this).html('<p class="text3-KS savedMessage"><i class="fa fa-times" aria-hidden="true" style="color: #C10003"></i>&nbsp;{!$Label.ks_notsaved}.&nbsp;{!$Label.oferta_alert_errores}</p>');
                    });
                    
                } else if(result.includes("KSEVERYTHINGISFINE_")) {
                
                    var totales = result.split("_");
                    $(".totalNeto").html('EUR ' + totales[1]);
                    $(".totalMargen").html(totales[2] + ' %');
                    $(".totalPVP").html('EUR ' + totales[3]);

                    $('.savedMessage').each(function() {
                        $(this).html('<p class="text3-KS savedMessage"><i class="fa fa-check" aria-hidden="true" style="color: #00C103"></i>&nbsp;{!$Label.ks_saved}</p>');
                    });
                    
                    if (campo == 'KS_Destinatario__c') {
                        var row = $(objeto).parent().parent().parent();
                        $(row).find(".descuento").each(function() {
                            if ($(this).prop('value')!=100) {
                                $(this).prop('readonly', false);
                            } else {
                                $(this).prop('readonly', true);
                            }
                        });
                    }   
                }
        },
            {escape: true}
        );
    }
    </script>
    
    <apex:form id="formulario">
        <style>
            body { font-family: Arial, Heletica, sans-serif; color: #000000; margin: 0; padding: 0; }
            p { margin: 0; padding: 0; }
            .clearfix-KS:after { visibility: hidden; display: block; font-size: 0; content: " "; clear: both; height: 0; }
            * html .clearfix-KS { zoom: 1; } /* IE6 */
            *:first-child+html .clearfix-KS { zoom: 1; } /* IE7 */
            input, select, textarea { -webkit-box-sizing: border-box; -moz-box-sizing: border-box; box-sizing: border-box; }
            .body-KS { width: 100%; }
            .body-KS a { text-decoration: none !important; color: #000000 !important; -webkit-transition: all 300ms ease; -moz-transition: all 300ms ease; -o-transition: all 300ms ease; transition: all 300ms ease; }
            .body-KS a:hover { text-decoration: none !important; color: #0061a4 !important; }
            .content-KS { width: 95%; margin: 0 auto; }
            .top-KS { width: 100%; }
            .right-KS { float: right; }
            .left-KS { float: left; }
            .pc50-KS { width: 50%; }
            .pc40-KS { width: 40%; }
            .pc30-KS { width: 30%; }
            .pc25-KS { width: 25%; }
            .pc20-KS { width: 20%; }
            .pc15-KS { width: 15%; }
            .pc10-KS { width: 10%; }
            .text1-KS { font-size: 11px; line-height: 14px; }
            .ayuda-KS { font-size: 11px; line-height: 14px; text-align: right; }
            .text2-KS { font-size: 16px; font-weight: bold; line-height: 18px; }
            .input1-KS { width: 300px; border-radius: 2px 2px 2px 2px; -moz-border-radius: 2px 2px 2px 2px; -webkit-border-radius: 2px 2px 2px 2px; border: 1px solid #dddddd; height: 27px; font-family: Arial, Helvetica, sans-serif; font-size: 12px; color: #000000; padding: 3px; background-color: #ffffff; font-weight: bold; }
            input:focus { outline: none; border: 1px solid #8b8b8b !important; }
            input[type=submit] { width: 150px; height: 35px; color: #0061a4; font-family: Arial, Helvetica, sans-serif; font-size: 12px; -webkit-appearance: none; border: 1px solid #0061a4; background-color: transparent; border-radius: 4px 4px 4px 4px; -moz-border-radius: 4px 4px 4px 4px; -webkit-border-radius: 4px 4px 4px 4px; margin-right: 10px; }
            input[class=guardar-KS] { background-color: #0061a4; color: #ffffff; float: left; -webkit-transition: all 300ms ease; -moz-transition: all 300ms ease; -o-transition: all 300ms ease; transition: all 300ms ease; }
            input[class=guardar-KS]:hover { background-color: #4c90bf; border-color: #4c90bf }
            input[type=button] { width: 150px; height: 35px; color: #0061a4; font-family: Arial, Helvetica, sans-serif; font-size: 12px; -webkit-appearance: none; border: 1px solid #0061a4; background-color: transparent; border-radius: 4px 4px 4px 4px; -moz-border-radius: 4px 4px 4px 4px; -webkit-border-radius: 4px 4px 4px 4px; margin-right: 10px; text-align:center;}
            input[class=salir_ficha-KS] { float: left; -webkit-transition: all 300ms ease; -moz-transition: all 300ms ease; -o-transition: all 300ms ease; transition: all 300ms ease; }
            input[class=salir_ficha-KS]:hover { background-color: #0061a4; color: #ffffff; }
            .ks-fichaLINKDUP, .ks-fichaLINKADD, .ks-fichaLINKDEL { cursor: pointer; }
            .ks-fichaLINKDUP:hover, .ks-fichaLINKADD:hover, .ks-fichaLINKDEL:hover  { color: #0061a4; }
            .text3-KS { float: left; font-size: 12px; line-height: 35px; }
            .top2-KS { margin-bottom: 20px; }
            .top3-KS { margin-bottom: 30px; }
            .top3-KS input { width: 40px; }
            .top3-KS input[name=competencia] { width: 166px; }
            .top3-KS textarea { vertical-align: top; border-radius: 2px 2px 2px 2px; -moz-border-radius: 2px 2px 2px 2px; -webkit-border-radius: 2px 2px 2px 2px; border: 1px solid #dddddd; font-family: Arial, Helvetica, sans-serif; font-size: 12px; color: #000000; padding: 3px; background-color: #ffffff; }
            .top3-KS input { border-radius: 2px 2px 2px 2px; -moz-border-radius: 2px 2px 2px 2px; -webkit-border-radius: 2px 2px 2px 2px; border: 1px solid #dddddd; font-family: Arial, Helvetica, sans-serif; font-size: 12px; color: #000000; padding: 3px; background-color: #ffffff; }
            .text4-KS { float: left; font-size: 12px; }
            .option { border-left: 1px dashed #0061a4; padding: 0 10px; height: 100px; }
            .option:first-child { border-left: 0; }
            .top4-KS { height: 3px; background-color: #0061a4; }
            .icon-KS { width: 50px; text-align: center; margin: 0 auto; top: -14px; position: relative; }
            .menu1-KS { margin-top: 25px; }
            .select-all-KS { width: 20px; padding: 7px 10px; border: 1px solid #dddddd; text-align: center; border-radius: 3px; float: left; margin-right: 10px; }
            .text5-KS { font-size: 12px; line-height: 19px; }
            .fa-chevron-circle-up { -webkit-transition: all 300ms ease; -moz-transition: all 300ms ease; -o-transition: all 300ms ease; transition: all 300ms ease; }
            .table-KS { margin-top: 20px; }
            /*tabla*/
            .table-KS, .table-KS table { width: 100%; }
            .table-KS tbody tr { background: #f6f6f6; }
            .table-KS tbody tr:nth-of-type(odd) { background: #e9e9e9; }
            .table-KS thead { font-weight: 100 !important; color: #ffffff; background: #0061a4; text-align: left; }
            .table-KS td, .table-KS th { padding: 5px 5px; }
            .table-KS td, .table-KS th { font-size: 12px; text-align: left; }
            td[class=searchIcon-KS]:hover { color: #0061a4; cursor: pointer; }
            td[class=searchIcon-KS]:hover>i { color: #0061a4; cursor: pointer; }
            /*tabla*/
            input[class=addN] { width: 25px; text-align: right; border-radius: 2px 2px 2px 2px; -moz-border-radius: 2px 2px 2px 2px; -webkit-border-radius: 2px 2px 2px 2px; border: 1px solid #dddddd; font-family: Arial, Helvetica, sans-serif; font-size: 12px; color: #000000; padding: 3px; background-color: #ffffff; }
            /*input[class=add-KS] { width: 100px !important; margin-left: 20px; padding: 5px 0px; line-height: 14px; color: #000000; border-color: #dddddd; -webkit-transition: all 300ms ease; -moz-transition: all 300ms ease; -o-transition: all 300ms ease; transition: all 300ms ease; }
            input[class=add-KS]:hover, input[class=add-KS]:focus { color: #ffffff; background-color: #7c7c7c; border: 1px solid #7c7c7c !important; }*/
            textarea:focus { outline: none !important; border: 1px solid #7c7c7c; }
            /*.delete-sel-KS, .duplicate-KS, .search-KS, .import-KS { width: auto !important; padding: 5px 10px; font-size: 12px; color: #000000 !important; border-color: #dddddd !important; -webkit-transition: all 300ms ease; -moz-transition: all 300ms ease; -o-transition: all 300ms ease; transition: all 300ms ease; }
            .delete-sel-KS:hover, .duplicate-KS:hover, .search-KS:hover, .import-KS:hover, .delete-sel-KS:focus, .duplicate-KS:focus, .search-KS:focus, .import-KS:focus { color: #ffffff !important; background-color: #8b8b8b !important; border: 1px solid #7c7c7c !important; }*/
            .menu-boxes-KS { float: left; }
            input[class=add-KS] { width: 100px !important; margin-left: 20px; padding: 5px 0px; line-height: 14px; background-color: #ffffff; color: #0061a4; border-color: #0061a4; -webkit-transition: all 300ms ease; -moz-transition: all 300ms ease; -o-transition: all 300ms ease; transition: all 300ms ease; }
            input[class=add-KS]:hover { background-color: #0061a4; color: #ffffff; }
            .delete-sel-KS, .duplicate-KS, .search-KS { background-color: #0061a4; color: #ffffff; float: left; -webkit-transition: all 300ms ease; -moz-transition: all 300ms ease; -o-transition: all 300ms ease; transition: all 300ms ease; }
            .import-KS { width: 200px !important; background-color: #0061a4; color: #ffffff; float: left; -webkit-transition: all 300ms ease; -moz-transition: all 300ms ease; -o-transition: all 300ms ease; transition: all 300ms ease; }
            .delete-sel-KS:hover, .duplicate-KS:hover, .search-KS:hover, .import-KS:hover, .delete-sel-KS:focus, .duplicate-KS:focus, .search-KS:focus, .import-KS:focus { background-color: #0061a4; color: #ffffff; }
            /*Import*/
            .import-popup-KS { display: none; width: 100%; height: 100%; background-color: rgba(0,0,0,0.65); position: absolute; z-index: 9999; -webkit-transition: all 300ms ease; -moz-transition: all 300ms ease; -o-transition: all 300ms ease; transition: all 300ms ease;}
            .content-import-popup-KS { width: 700px; height: 525px; background-color: #ffffff; position: relative; top: calc(50% - 285px); margin: 0 auto; border-radius: 10px 10px 10px 10px; -moz-border-radius: 10px 10px 10px 10px; -webkit-border-radius: 10px 10px 10px 10px; padding: 30px; }
            .content-import-popup-KS h2 { margin: 0 0 20px 0; font-weight: 100; font-size: 22px; }
            .content-import-popup-KS p { margin: 0 0 20px 0; font-weight: 100; font-size: 13px; }
            .ejemplo-KS { margin: 0 0 20px 20px !important; font-weight: 100; font-size: 13px; color: #7b7b7b; }
            .file-KS { margin: 0 0 20px 20px !important; font-weight: 100; font-size: 13px; }
            .file-KS i { font-size: 20px; }
            .content-import-popup-KS textarea { width: 100%; height: 120px; margin-top: 30px; margin-bottom: 30px; }
            .icon-warning-KS { width: 50px; }
            .icon-warning-KS i { font-size: 40px; color: #C70105; text-align: center; line-height: 60px; }
            .text-warning-KS { width: 650px; }
            .buttons-import-KS { margin-top: 30px; text-align: center; }
            input[class=importar-KS] { background-color: #0061a4; color: #ffffff; -webkit-transition: all 300ms ease; -moz-transition: all 300ms ease; -o-transition: all 300ms ease; transition: all 300ms ease; }
            input[class=importar-KS]:hover { background-color: #4c90bf; border-color: #4c90bf }
            input[class=importar-KS]:disabled { background-color: #cccccc; border-color: #cccccc }
            input[class=cancelar-KS] { -webkit-transition: all 300ms ease; -moz-transition: all 300ms ease; -o-transition: all 300ms ease; transition: all 300ms ease; }
            input[class=cancelar-KS]:hover { background-color: #0061a4; color: #ffffff; }
            .close-import-KS { position: absolute; right: 30px; }
            .close-import-KS i { font-size: 20px; color: #cccccc; }
            /*Import*/
            /*HELP*/
            .help-popup-KS { display: none; width: 100%; height: 100%; background-color: rgba(0,0,0,0.65); position: absolute; z-index: 9999; -webkit-transition: all 300ms ease; -moz-transition: all 300ms ease; -o-transition: all 300ms ease; transition: all 300ms ease;}
            .content-help-popup-KS { width: 700px; height: 550px; background-color: #ffffff; position: relative; top: calc(50% - 320px); margin: 0 auto; border-radius: 10px 10px 10px 10px; -moz-border-radius: 10px 10px 10px 10px; -webkit-border-radius: 10px 10px 10px 10px; padding: 30px; }
            .content-help-popup-KS h2 { margin: 0 0 20px 0; font-weight: 100; font-size: 22px; }
            .content-help-popup-KS p { margin: 0 0 20px 0; font-weight: 100; font-size: 13px; }
            .content-help-popup-KS textarea { width: 100%; height: 120px; margin-top: 30px; margin-bottom: 30px; }
            .close-help-KS { position: absolute; right: 30px; }
            .close-help-KS i { font-size: 20px; color: #cccccc; }
            /*ERROR*/
            .error-KS { float: left; font-size: 16px; line-height: 35px; color: #C10003;}
            /*ERROR*/
            /*SALESFORCE*/
            body .bDetailBlock.bPageBlock .pbBody .dataCol { border: none; }
            /*SALESFORCE*/
        </style>

        <apex:outputPanel id="toda-la-ficha">
            
            <apex:actionFunction action="{!callSaveLineas}" name="hiddenSaveLineas"
                                 reRender="scriptFormulario, errores, fichaCabecera"/>
            <apex:actionFunction action="{!callSaveLineas}" name="callSaveLineas" 
                                 reRender="toda-la-ficha"/>
            <apex:actionFunction action="{!callCalcTotales}" name="calcTotales"
                                 reRender="scriptFormulario, errores, fichaCabecera"/>
            <apex:actionFunction action="{!callSaveLineasRefresh}" name="callSaveLineasRefresh"/>
            <script type="text/javascript">
            function repairDecimal() {
                $('.descuento').each(function() {
                    $(this).prop(
                        'value', 
                        $(this).prop('value').replace('.', ',')
                    )
                });
            }    
            function saveLineasRefresh() {
                repairDecimal();
                callSaveLineasRefresh();
            }    
            function saveLineas() {
                repairDecimal();
                callSaveLineas();
            }
            </script>
            
            <div class="import-popup-KS">
                <br/><br/>
                <apex:outputPanel id="popupReferencias">
                    
                    <div class="content-import-popup-KS">
                        <div class="close-import-KS" style="cursor:pointer;"><i class="fa fa-times-circle-o" aria-hidden="true"></i></div>
                        <h2>&nbsp;{!$Label.oferta_addprod_importar}</h2>
                        <br/><br/>
                        <p>{!$Label.oferta_addprod_importar_1}&nbsp;</p>
                        <p class="ejemplo-KS">CodProd,Cant,DtoExtra|CodProd,Cant,DtoExtra|CodProd,Cant,DtoExtra|CodProd,Cant,DtoExtra </p>
                        <p>{!$Label.oferta_addprod_importar_2}</p>
                        <p class="file-KS">
                            <i class="fa fa-file-text-o" aria-hidden="true"></i> 
                            <span>
                                <u>
                                    <a href="{!URLFOR($Resource.ImportadorReferencias)}" 
                                       target="_blank">{!$Label.ks_btn_import}.xlsx</a>
                                </u>
                            </span>
                        </p>
                        <apex:inputTextarea id="warning-textarea-KS" styleClass="warning-textarea-KS" rows="4" cols="50" 
                                            html-placeholder="{!$Label.oferta_addprod_importar_textarea}" value="{!referencias}"/>
                        <div class="warning-KS">
                            <div class="left-KS icon-warning-KS"><i class="fa fa-exclamation-triangle" aria-hidden="true"></i></div>
                            <div class="left-KS  text-warning-KS">
                                <p><strong>{!$Label.ks_importante}:</strong><br/>{!$Label.oferta_addprod_importar_3}</p>
                            </div>
                        </div>
                        <div class="buttons-import-KS">
                            <input type="button" class="cancelar-KS" value="{!$Label.ks_btn_cancel}"/>
                            <apex:actionFunction action="{!callAddReferencias}" name="addReferencias" 
                                                 reRender="formulario"/>
                            <input type="button" class="importar-KS" value="{!$Label.ks_btn_import}" onclick="addReferencias();$('.import-popup-KS').hide();"/>
                        </div>
                    </div>
                </apex:outputPanel>
            </div>
            
            <div class="help-popup-KS">
                <br/><br/>
                <div class="content-help-popup-KS">
                    <div class="close-help-KS" onclick="$('.help-popup-KS').toggle( );/*$('#setVideoHere').prop('src', '');*/" style="cursor:pointer;"><i class="fa fa-times-circle-o" aria-hidden="true"></i></div>
                    <br/><br/>
                    <div width="50%" style="float:right;">
                        <table>
                        <tr><th COLSPAN="2">VIDEOTUTORIAL EN DETALLE</th></tr>
                        
                            <tr><td COLSPAN="2"><a href="" style="cursor:pointer;" onclick="setIframeVideo('219368373');"><u>01 Introducción Referencias Fichas</u></a></td></tr>
                            <tr><td COLSPAN="2"><a href="" style="cursor:pointer;" onclick="setIframeVideo('219481117');"><u>02 Importador Referencias</u></a></td></tr>
                            <tr><td COLSPAN="2"><a href="" style="cursor:pointer;" onclick="setIframeVideo('219481137');"><u>03 Gestión de Fichas</u></a></td></tr>
                            <tr><td COLSPAN="2"><a href="" style="cursor:pointer;" onclick="setIframeVideo('219481105');"><u>04 Aprobaciones y Cálculo Dto. Logístico</u></a></td></tr>
                            <tr><td COLSPAN="2"></td></tr>
                            <tr><td COLSPAN="2"><b>Contraseña:</b> Piloto</td></tr>
                        </table>
                    </div> 
                    
                    <div width="50%" style="float:left;">
                        <table>
                        <tr><th COLSPAN="2">VIDEOTUTORIAL</th></tr>
                        
                        <tr><td COLSPAN="2"><a href="" style="cursor:pointer;" onclick="setIframeVideo('219830687');"><u>01 Conceptos básicos</u></a></td></tr>
                        <tr><td COLSPAN="2"><a href="" style="cursor:pointer;" onclick="setIframeVideo('219830702');"><u>02 Buscador y edición</u></a></td></tr>
                        <tr><td COLSPAN="2"><a href="" style="cursor:pointer;" onclick="setIframeVideo('219830716');"><u>03 Edición avanzada y descuentos</u></a></td></tr>
                        <tr><td COLSPAN="2"><a href="" style="cursor:pointer;" onclick="setIframeVideo('219830727');"><u>04 Importador de Referencias</u></a></td></tr>
                        <tr><td COLSPAN="2"><a href="" style="cursor:pointer;" onclick="setIframeVideo('219830675');"><u>05 Gestión de Fichas</u></a></td></tr>
                        <tr><td COLSPAN="2"><a href="" style="cursor:pointer;" onclick="setIframeVideo('219830678');"><u>06 Aprobaciones y Dto Logístico</u></a></td></tr>
                        
                            
                        </table>
                    </div>
                    
                    <script type="text/javascript">
                    function setIframeVideo(videoID) {
                        $('#setVideoHere').prop('src', 'https://player.vimeo.com/video/' + videoID);
                    }
                    </script>
                    
                    <br/>
                    <iframe id="setVideoHere" src="" width="640" height="400" frameborder="0" webkitallowfullscreen="true" mozallowfullscreen="true" allowfullscreen="true"></iframe>
                </div>
            </div>
            
            <div class="body-KS">
                <br/><br/>
                <div class="content-KS">
                    <apex:outputPanel id="fichaCabecera">
                        <div class="top-KS top1-KS clearfix-KS">
                            <div class="left-KS pc50-KS">
                                <p class="text1-KS">{!$Label.oferta_addprod_header}</p>
                            </div>
                            <div class="left-KS pc50-KS">
                                <p class="ayuda-KS"><!-- href="/apex/KS_Oferta_Tutorial"-->
                                    <a href="" onclick="$('.help-popup-KS').toggle( );" style="cursor:pointer;"
                                       title="" target="_blank">{!$Label.oferta_addprod_help}&nbsp;<i class="fa fa-question-circle" aria-hidden="true"></i></a></p>
                            </div>
                        </div>
                        <div class="top-KS top2-KS clearfix-KS">
                            <div class="left-KS pc50-KS">
                                <p class="text2-KS">{!oferta.Name}</p>
                                <apex:input id="fichaNombreInput" value="{!fichaNombre}" styleclass="input1-KS" 
                                            html-placeholder="{!$ObjectType.OpportunityLineItem.fields.KS_Ficha_Nombre__c.Label}" onchange="callSaveLineas();"/>
                            </div>
                            <div class="left-KS pc50-KS">
                                <input type="button" class="salir_ficha-KS" value="{!$Label.ks_btn_salir} {!$Label.Oferta_Ficha}" onclick="location.href='{!salir}'"/>
                                <input type="button" class="guardar-KS" value="{!$Label.ks_btn_guardar}" onclick="saveLineasRefresh();"/>
                                <apex:outputPanel rendered="{!notSaved}">
                                    <p class="text3-KS savedMessage">
                                        <i class="fa fa-times" aria-hidden="true" style="color: #C10003"></i>
                                        &nbsp;{!$Label.ks_notsaved}.&nbsp;
                                        <apex:outputText rendered="{!haveError}">{!$Label.oferta_alert_errores}</apex:outputText>
                                        <apex:outputText rendered="{!notSaved&&NOT(haveError)}">{!$Label.oferta_alert_lineas}</apex:outputText>
                                    </p>
                                </apex:outputPanel>
                                <apex:outputPanel rendered="{!saved}">
                                    <p class="text3-KS savedMessage"><i class="fa fa-check" aria-hidden="true" style="color: #00C103"></i>&nbsp;{!$Label.ks_saved}</p>
                                </apex:outputPanel>
                            </div>
                        </div>
                        <div class="top-KS top3-KS clearfix-KS">
                            <div class="left-KS pc20-KS option">
                                <p class="text4-KS"> 
                                    <apex:pageBlock mode="maindetail">
                                        <apex:pageBlockSection >
                                            <apex:pageBlockSectionItem >
                                                {!$Label.Oferta_Ficha_of}:
                                            </apex:pageBlockSectionItem>
                                            <apex:pageBlockSectionItem >
                                                <strong>{!fichaActualIndex}&nbsp;de&nbsp;{!fichaMaximaVal}&nbsp;</strong>
                                            </apex:pageBlockSectionItem>
                                            <apex:pageBlockSectionItem >
                                                {!$ObjectType.OpportunityLineItem.fields.KS_Cantidad_Ficha__c.Label}:
                                            </apex:pageBlockSectionItem>
                                            <apex:pageBlockSectionItem >
                                                <apex:inputText value="{!fichaCantidad}" onchange="calcLogistico();"/>
                                            </apex:pageBlockSectionItem>
                                        </apex:pageBlockSection>
                                    </apex:pageBlock>
                                </p>
                            </div>
                            <div class="left-KS pc15-KS option">
                                <p class="text4-KS"> 
                                    <apex:pageBlock mode="maindetail">
                                        <apex:pageBlockSection >
                                            <apex:pageBlockSectionItem >
                                                {!$ObjectType.OpportunityLineItem.fields.KS_Dto_adicional_2__c.Label}:
                                            </apex:pageBlockSectionItem>
                                            <apex:pageBlockSectionItem >
                                                <input type="text" class="dtoextraficha" onchange="setdescuento(this,'dtoextra');"/>
                                            </apex:pageBlockSectionItem>
                                            
                                            <apex:pageBlockSectionItem >
                                                {!$ObjectType.OpportunityLineItem.fields.KS_Dto_Instalador__c.Label}:
                                            </apex:pageBlockSectionItem>
                                            <apex:pageBlockSectionItem >
                                                <input type="text" class="dtoinstaficha" onchange="setdescuento(this,'dtoinsta');"/>
                                            </apex:pageBlockSectionItem>
                                            
                                            <apex:pageBlockSectionItem >
                                                {!$ObjectType.OpportunityLineItem.fields.KS_Dto_cliente_final__c.Label}:
                                            </apex:pageBlockSectionItem>
                                            <apex:pageBlockSectionItem >
                                                <input type="text" class="dtofinalficha" onchange="setdescuento(this,'dtofinal');"/>
                                            </apex:pageBlockSectionItem>
                                        </apex:pageBlockSection>
                                    </apex:pageBlock>
                                </p>
                            </div>
                            <div class="left-KS pc15-KS option">
                                <apex:outputPanel id="totalesFicha">
                                    <p class="text4-KS">
                                        <apex:pageBlock mode="maindetail">
                                            <apex:pageBlockSection >
                                                <apex:pageBlockSectionItem >
                                                    {!$Label.oferta_ficha_sumaPVP}:
                                                </apex:pageBlockSectionItem>
                                                <apex:pageBlockSectionItem >
                                                    <strong class="totalPVP">EUR {!totales.pvp}</strong>
                                                </apex:pageBlockSectionItem>
                                                
                                                <apex:pageBlockSectionItem >
                                                    {!$ObjectType.OpportunityLineItem.fields.KS_precio_neto__c.Label}:
                                                </apex:pageBlockSectionItem>
                                                <apex:pageBlockSectionItem >
                                                    <strong class="totalNeto">EUR {!totales.neto}</strong>
                                                </apex:pageBlockSectionItem>
                                                
                                                <apex:pageBlockSectionItem >
                                                    {!$Label.oferta_ficha_descuentoDistr}:
                                                </apex:pageBlockSectionItem>
                                                <apex:pageBlockSectionItem >
                                                    <strong class="totalMargen">{!totales.margen} %</strong>
                                                </apex:pageBlockSectionItem>
                                            </apex:pageBlockSection>
                                        </apex:pageBlock>
                                    </p>
                                </apex:outputPanel>
                            </div>
                            <div class="left-KS pc20-KS option">
                                <p class="text4-KS">
                                    <apex:pageBlock mode="maindetail">
                                        <apex:pageBlockSection >
                                            <apex:pageBlockSectionItem >
                                                {!$ObjectType.OpportunityLineItem.fields.KS_Competidor__c.Label}:
                                            </apex:pageBlockSectionItem>
                                            <apex:pageBlockSectionItem >
                                                <apex:inputField value="{!fichaComp.KS_Competidor__c}" style="width:60%"
                                                                 onchange="hiddenSaveLineas();"/>
                                            </apex:pageBlockSectionItem>
                                            
                                            <apex:pageBlockSectionItem >
                                                {!$ObjectType.OpportunityLineItem.fields.KS_Comentarios__c.Label}:
                                            </apex:pageBlockSectionItem>
                                            <apex:pageBlockSectionItem >
                                                <apex:inputTextarea value="{!fichaComentario}" rows="4" cols="25"
                                                                    onchange="hiddenSaveLineas();"/>
                                            </apex:pageBlockSectionItem>
                                        </apex:pageBlockSection>
                                    </apex:pageBlock>
                                </p>
                            </div>
                            <div class="left-KS pc15-KS option">
                                <apex:actionFunction action="{!callDupFicha}" name="callDupFicha" 
                                                     reRender="formulario"/>
                                <apex:actionFunction action="{!callAddFicha}" name="callAddFicha" 
                                                     reRender="formulario"/>
                                <apex:actionFunction action="{!callDelFicha}" name="delFicha" 
                                                     reRender="formulario"/>
                                <p class="text4-KS">
                                    <span class="ks-fichaLINK ks-fichaLINKDUP">
                                        <i class="fa fa-files-o" aria-hidden="true"></i>&nbsp;{!$Label.ks_btn_duplicar}&nbsp;{!$Label.Oferta_Ficha}</span> <br/>
                                    <br/>
                                    <span class="ks-fichaLINK ks-fichaLINKADD">
                                        <i class="fa fa-plus-square-o" aria-hidden="true"></i>&nbsp;{!$Label.ks_btn_new_fem}&nbsp;{!$Label.Oferta_Ficha}</span> <br/>
                                    <br/>
                                    <span class="ks-fichaLINK ks-fichaLINKDEL">
                                        <i class="fa fa-times" aria-hidden="true"></i>&nbsp;{!$Label.ks_btn_delete}&nbsp;{!$Label.Oferta_Ficha}</span>
                                    <br/><br/>
                                    <apex:actionFunction action="{!callChangeFicha}" name="callChangeFicha" 
                                                         reRender="formulario"/>
                                    <span class="ks-fichaLINK ks-fichaGOTO">
                                        <i class="fa fa-share" aria-hidden="true"></i>&nbsp;{!$Label.ks_navegarto}:&nbsp;</span>
                                    <apex:selectList styleclass="fichaField" value="{!fichaSelect}" id="fichaActual" onchange="changeFicha();" size="1">
                                        <apex:selectOptions value="{!fichasSelect}"/>
                                    </apex:selectList>
                                </p>
                                <script type="text/javascript">
                                $('.ks-fichaLINKDUP').click(function () { dupFicha(); });
                                $('.ks-fichaLINKADD').click(function () { addFicha(); });
                                $('.ks-fichaLINKDEL').click(function () { if (confirm('{!$Label.oferta_alert_delficha}')) { delFicha(); } });
                                function addFicha() {
                                    if ({!haveError} || $('#error-remote').is(":visible") ) {
                                        if (confirm('{!$Label.oferta_alert_navegar} {!$Label.oferta_alert_errores}'))
                                        {callAddFicha();}
                                        else
                                        {$('.fichaField').val('{!fichaSelect}');}
                                    } else if ({!notSaved}) {
                                        if (confirm('{!$Label.oferta_alert_navegar} {!$Label.oferta_alert_lineas}'))
                                        {callAddFicha();}
                                        else
                                        {$('.fichaField').val('{!fichaSelect}');}
                                    } else {
                                        callAddFicha();
                                    }
                                } 
                                function dupFicha() {
                                    if ({!haveError} || $('#error-remote').is(":visible") ) {
                                        if (confirm('{!$Label.oferta_alert_navegar} {!$Label.oferta_alert_errores}'))
                                        {callDupFicha();}
                                        else
                                        {$('.fichaField').val('{!fichaSelect}');}
                                    } else if ({!notSaved}) {
                                        if (confirm('{!$Label.oferta_alert_navegar} {!$Label.oferta_alert_lineas}'))
                                        {callDupFicha();}
                                        else
                                        {$('.fichaField').val('{!fichaSelect}');}
                                    } else {
                                        callDupFicha();
                                    }
                                } 
                                function changeFicha() {
                                    if ({!haveError} || $('#error-remote').is(":visible") ) {
                                        if (confirm('{!$Label.oferta_alert_navegar} {!$Label.oferta_alert_errores}'))
                                        {callChangeFicha();}
                                        else
                                        {$('.fichaField').val('{!fichaSelect}');}
                                    } else if ({!notSaved}) {
                                        if (confirm('{!$Label.oferta_alert_navegar} {!$Label.oferta_alert_lineas}'))
                                        {callChangeFicha();}
                                        else
                                        {$('.fichaField').val('{!fichaSelect}');}
                                    } else {
                                        callChangeFicha();
                                    }
                                }    
                                </script>
                            </div>
                        </div>
                    </apex:outputPanel>
                    
                    <div class="top-KS top4-KS clearfix-KS">
                        <div class="icon-KS"> <span class="fa-stack"> <i class="fa fa-circle fa-stack-2x" style="color: #ffffff"></i> <i class="fa fa-chevron-circle-up fa-stack-2x fa-inverse" style="color: #0061a4"></i> </span> </div>
                    </div>
                    <div class="top-KS menu1-KS clearfix-KS">
                        <div class="menu-boxes-KS">
                            <apex:actionFunction action="{!callDelProductos}" name="delProductos" 
                                                 reRender="formulario"/>
                            <input type="button" class="delete-sel-KS" value="{!$Label.ks_btn_delete} {!$Label.ks_selected}" 
                                   onclick="if (confirm('{!$Label.oferta_alert_delprod}')) { delProductos(); }"/>
                        </div>
                        <div class="menu-boxes-KS">
                            <apex:actionFunction action="{!callDupProductos}" name="dupProductos" 
                                                 reRender="formulario"/>
                            <input type="button" class="duplicate-KS" value="{!$Label.ks_btn_duplicar} {!$Label.ks_selected}" onclick="dupProductos();"/>
                        </div>
                        <!--<div class="menu-boxes-KS">
                        <input type="button" class="search-KS" value="{!$Label.ks_btn_buscar} {!$Label.Productos}"/>
                        </div>-->
                        <div class="menu-boxes-KS">
                            <input type="button" class="import-KS" value="{!$Label.oferta_addprod_importar}"/>
                        </div>
                        <div class="menu-boxes-KS">
                            <apex:actionFunction action="{!callCalcLogistico}" name="calcLogistico"/>
                            <input type="button" class="duplicate-KS" value="{!$Label.ks_btn_calcular} {!$ObjectType.OpportunityLineItem.fields.KS_Dto_logistico__c.Label}" onclick="calcLogistico();"/>
                        </div>
                        <div class="menu-boxes-KS">
                            <apex:actionFunction action="{!callCalcAprobaciones}" name="calcAprobaciones"/>
                            <input type="button" class="duplicate-KS" value="{!$Label.ks_btn_calcular} {!$ObjectType.OpportunityLineItem.fields.KS_Aprobacion__c.Label}" onclick="calcAprobaciones();"/>
                        </div>
                    </div>
                    
                    <apex:actionFunction action="{!callSelProducto}" name="selProducto" 
                                         reRender="toda-la-ficha"/>
                    <apex:actionFunction action="{!callDatosProducto}" name="getDatosProducto" 
                                         reRender="toda-la-ficha"/>
                    <div class="productoLookupDIV">
                        <apex:inputHidden id="productoIDROW" value="{!productoIDROW}"/>
                        <apex:inputHidden id="productoLookup" value="{!productoLookup}"/>
                    </div>
                    <script type="text/javascript">
                    function getProducto(idProducto) {
                        $(".productoLookupDIV").find(":last-child").prop("value", idProducto);
                        getDatosProducto();
                    }
                    </script>

                    <apex:outputPanel id="errores">
                        
                        <apex:outputPanel id="errorReferencias" rendered="{!errorReferencias}">
                            <p class="error-KS"><i class="fa fa-times" aria-hidden="true" style="color: #C10003"></i> {!validacionReferencias}</p>
                        </apex:outputPanel>
                        
                        <div id="error-remote" style="{!if(haveError,'','display:none;')}">
                            <p class="error-KS">
                                <i class="fa fa-times" aria-hidden="true" style="color: #C10003"></i> 
                                <span id="error-remote-text">{!errorGeneric}</span>
                            </p>
                        </div>
                        
                    </apex:outputPanel>
                    
                    <apex:outputPanel id="listaProductos">
                        
                        <div class="table-KS clearfix-KS">
                            <table border="0" cellspacing="0" cellpadding="0">
                                <thead>
                                    <tr>
                                        <th width="30">
                                            <input type="checkbox" class="selectProdAll" onchange="marcarTodos(this,'selectProd');"/>
                                        </th>
                                        <th></th>
                                        <th>{!$ObjectType.Product2.fields.ProductCode.Label}</th>
                                        <th>{!$Label.ks_nombre}</th>
                                        <th>{!$ObjectType.OpportunityLineItem.fields.UnitPrice.Label}</th>
                                        <th>{!$ObjectType.OpportunityLineItem.fields.KS_Cantidad__c.Label}</th>
                                        <th>{!$ObjectType.OpportunityLineItem.fields.KS_Dto_base_1__c.Label}</th>
                                        <th>{!$ObjectType.OpportunityLineItem.fields.KS_Dto_base_2__c.Label}</th>
                                        <th>{!$ObjectType.OpportunityLineItem.fields.KS_Dto_Campaign__c.Label}</th>
                                        <th>{!$ObjectType.OpportunityLineItem.fields.KS_Dto_adicional_2__c.Label}</th>
                                        <th>{!$ObjectType.OpportunityLineItem.fields.KS_Dto_Instalador__c.Label}</th>
                                        <th>{!$ObjectType.OpportunityLineItem.fields.KS_Dto_cliente_final__c.Label}</th>
                                        <th>{!$ObjectType.OpportunityLineItem.fields.KS_Dto_logistico__c.Label}</th>
                                        <th>
                                            <div>
                                                <span>{!$ObjectType.OpportunityLineItem.fields.KS_Prescrito__c.Label}&nbsp;</span>
                                                <span>(<apex:inputCheckbox value="{!prescritGlobal}" styleClass="prescritotodos" onclick="marcarTodos(this, 'prescrito')"/>)</span>
                                            </div>
                                        </th>
                                        <th>
                                            <div>
                                                <span>{!$ObjectType.OpportunityLineItem.fields.KS_Material_sin_cargo__c.Label}&nbsp;</span>
                                                <span>(</span>
                                                <apex:inputCheckbox value="{!sincargoGlobal}" styleClass="sincargotodos" onclick="marcarTodos(this, 'sincargo')">
                                                    <apex:actionSupport action="{!marcarSinCargo}" reRender="toda-la-ficha" event="onchange" status="status"/>
                                                </apex:inputCheckbox>
                                                <span>)</span>
                                            </div>
                                        </th>
                                        <th>{!$ObjectType.OpportunityLineItem.fields.KS_Destinatario__c.Label}</th>
                                        <th>{!$ObjectType.OpportunityLineItem.fields.KS_Referencia__c.Label}</th>
                                        <th>{!$ObjectType.OpportunityLineItem.fields.KS_Aprobacion__c.Label}</th>
                                        <th></th>
                                    </tr>
                                </thead>
                                <tbody id="tbody-KS">
                                    <apex:repeat value="{!orden}" var="ord">
                                        <tr class="rowLinea rowLinea{!productos[ord]}">
                                            <td>
                                                <apex:inputCheckBox styleclass="selectProd markit" value="{!productosSeleccion[productos[ord]]}"
                                                                    onchange="marcarGlobal('selectProd', 'selectProdAll');"/>
                                                <apex:inputField value="{!productosOferta[productos[ord]].KS_Orden__c}" styleclass="orden"/>
                                                <script type="text/javascript">
                                                $('.orden').hide();
                                                </script>
                                                <input type="hidden" name="" value="{!productosOferta[productos[ord]].ID}" class="idLinea"/>
                                                <input type="hidden" name="" value="{!productos[ord]}" class="keyProducto"/>
                                            </td>
                                            <td class="searchIcon-KS" style="text-align:center;">
                                                <i class="fa fa-search" aria-hidden="true" style="color: #999999;"></i>
                                            </td>
                                            <td>
                                                <c:AutoCompleteV2 allowClear="true" importJquery="false" labelField="KS_Material_Nombre__c" 
                                                                  SObject="KS_Condicion_Comercial__c" valueField="KS_Material__c" 
                                                                  targetField="{!productosMaterial[productos[ord]]}" whereClause="{!whereClause}" 
                                                                  style="width:200px"/>
                                                <input type="hidden" name="" value="{!productos[ord]}" class="idUnico {!productos[ord]}"/>
                                            </td>
                                            <td>
                                                <apex:outputField value="{!productosSalesF[productos[ord]].KS_Nombre_Producto__c}"/>
                                            </td>
                                            
                                            <td>
                                                <apex:outputField value="{!productosOferta[productos[ord]].UnitPrice}" rendered="{!productosMaterial[productos[ord]]!=pricelssProduct}"/>
                                                <apex:inputField value="{!productosOferta[productos[ord]].UnitPrice}" rendered="{!productosMaterial[productos[ord]]==pricelssProduct}"
                                                                 styleclass="descuento" onchange="setCampoValor('{!productosOferta[productos[ord]].ID}', 'UnitPrice', this, '{!fichaSelect}');"/>
                                            </td>
                                            
                                            <td style="text-align:center;">
                                                <apex:inputField value="{!productosOferta[productos[ord]].KS_Cantidad__c}" style="width: 40px;"
                                                                 styleClass="{!productos[ord]}_cantidad markit" rendered="{!productosOferta[productos[ord]].ID!=null}"
                                                                 onchange="setCampoValor('{!productosOferta[productos[ord]].ID}', 'KS_Cantidad__c', this, '{!fichaSelect}');"/>
                                            </td>
                                            <td><apex:outputField value="{!productosOferta[productos[ord]].KS_Dto_base_1__c}"/></td>
                                            <td><apex:outputField value="{!productosOferta[productos[ord]].KS_Dto_base_2__c}"/></td>
                                            <td><apex:outputField value="{!productosOferta[productos[ord]].KS_Dto_Campaign__c}"/></td>
                                            <td style="text-align:center;">
                                                <apex:inputField value="{!productosOferta[productos[ord]].KS_Dto_adicional_2__c}" rendered="{!productosOferta[productos[ord]].ID!=null}"
                                                                 styleClass="markit descuento dtoextra dto{!productos[ord]}" style="width: 40px;"
                                                                 onchange="setCampoValor('{!productosOferta[productos[ord]].ID}', 'KS_Dto_adicional_2__c', this, '{!fichaSelect}');"/>
                                            </td>
                                            <td style="text-align:center;">
                                                <apex:inputField value="{!productosOferta[productos[ord]].KS_Dto_Instalador__c}" rendered="{!productosOferta[productos[ord]].ID!=null}" 
                                                                 styleClass="markit descuento dtoinsta dto{!productos[ord]}" style="width: 40px;"
                                                                 onchange="setCampoValor('{!productosOferta[productos[ord]].ID}', 'KS_Dto_Instalador__c', this, '{!fichaSelect}');"/>
                                            </td>
                                            <td style="text-align:center;">
                                                <apex:inputField value="{!productosOferta[productos[ord]].KS_Dto_cliente_final__c}" rendered="{!productosOferta[productos[ord]].ID!=null}" 
                                                                 styleClass="markit descuento dtofinal dto{!productos[ord]}" style="width: 40px;"
                                                                 onchange="setCampoValor('{!productosOferta[productos[ord]].ID}', 'KS_Dto_cliente_final__c', this, '{!fichaSelect}');"/>
                                            </td>
                                            <td>
                                                <apex:outputField value="{!productosOferta[productos[ord]].KS_Dto_logistico__c}"/>
                                            </td>
                                            <td style="text-align:center;">
                                                <apex:inputField value="{!productosOferta[productos[ord]].KS_Prescrito__c}"
                                                                 styleClass="markit prescrito" rendered="{!productosOferta[productos[ord]].ID!=null}"
                                                                 onchange="setCampoValorCheck('{!productosOferta[productos[ord]].ID}', 'KS_Prescrito__c', this, '{!fichaSelect}'); marcarGlobal('prescrito', 'prescritotodos');"/>
                                            </td>
                                            <td style="text-align:center;">
                                                <apex:inputField value="{!productosOferta[productos[ord]].KS_Material_sin_cargo__c}" rendered="{!productosOferta[productos[ord]].ID!=null}"
                                                                 styleClass="markit sincargo" onchange="sinCargoCheck(this); marcarGlobal('sincargo', 'sincargotodos');"/>
                                            </td>
                                            <td>
                                                <apex:inputField value="{!productosOferta[productos[ord]].KS_Destinatario__c}"
                                                                 styleClass="markit" rendered="{!productosOferta[productos[ord]].ID!=null}"
                                                                 onchange="sinCargo(this); setCampoValor('{!productosOferta[productos[ord]].ID}', 'KS_Destinatario__c', this, '{!fichaSelect}');"/>
                                            </td>
                                            <td>
                                                <apex:inputField value="{!productosOferta[productos[ord]].KS_Referencia__c}" style="width: 40px;"
                                                                 styleClass="markit" rendered="{!productosOferta[productos[ord]].ID!=null}"
                                                                 onchange="setCampoValor('{!productosOferta[productos[ord]].ID}', 'KS_Referencia__c', this, '{!fichaSelect}');"/>
                                            </td>
                                            <td style="text-align:center;">
                                                <i class="fa {!aprobacionClass[productosOferta[productos[ord]].KS_Necesita_aprobacion__c]}" 
                                                   aria-hidden="true" style="color: {!aprobacionColor[productosOferta[productos[ord]].KS_Necesita_aprobacion__c]};"></i>
                                            </td>
                                            <td><i class="fa fa-arrows-v" aria-hidden="true" style="color: #999999;"></i></td>
                                        </tr>
                                        <script type="text/javascript">
                                        $('.dto{!productos[ord]}').each(function(){
                                            
                                            $(this).prop('readonly', false);
                                            
                                            if( $(this).hasClass('dtoextra') && {!productosOferta[productos[ord]].KS_Dest_Distribuidor__c} ) 
                                            { $(this).prop('readonly', true); }
                                            
                                            if( $(this).hasClass('dtoinsta') && {!productosOferta[productos[ord]].KS_Dest_Instalador__c} ) 
                                            { $(this).prop('readonly', true); }
                                            
                                            if( $(this).hasClass('dtofinal') && {!productosOferta[productos[ord]].KS_Dest_ClieFinal__c} ) 
                                            { $(this).prop('readonly', true); }
                                        });
                                        </script>
                                    </apex:repeat>
                                </tbody>
                            </table>
                        </div>
                        <div class="top menu1-KS clearfix-KS">
                            <div class="left-KS pc50-KS">
                                <p class="text4-KS">
                                    {!$Label.ks_btn_add}&nbsp;<apex:inputText styleClass="addN" id="addN" value="{!productosADD}"/>
                                    &nbsp;{!$Label.oferta_ficha_lineas_more}
                                    <apex:actionFunction action="{!callAddProductos}" name="addProductos" 
                                                         reRender="toda-la-ficha"/>
                                    <!--<input type="button" class="add-KS" id="add-KS" value="Añadir" onclick="addRow()"/>-->
                                    <input type="button" class="add-KS" id="add-KS" value="{!$Label.ks_btn_add}" onclick="addProductos()"/>
                                </p>
                            </div>
                            <div class="left-KS pc50-KS">
                                <input type="button" class="salir_ficha-KS" value="{!$Label.ks_btn_salir} {!$Label.Oferta_Ficha}" onclick="location.href='{!salir}'"/>
                                <input type="button" class="guardar-KS" value="{!$Label.ks_btn_guardar}" onclick="saveLineasRefresh();"/>
                                
                                <apex:outputPanel rendered="{!notSaved}">
                                    <p class="text3-KS savedMessage">
                                        <i class="fa fa-times" aria-hidden="true" style="color: #C10003"></i>
                                        &nbsp;{!$Label.ks_notsaved}.&nbsp;
                                        <apex:outputText rendered="{!haveError}">{!$Label.oferta_alert_errores}</apex:outputText>
                                        <apex:outputText rendered="{!notSaved&&NOT(haveError)}">{!$Label.oferta_alert_lineas}</apex:outputText>
                                    </p>
                                </apex:outputPanel>
                                
                                <apex:outputPanel rendered="{!saved}">
                                    <p class="text3-KS savedMessage"><i class="fa fa-check" aria-hidden="true" style="color: #00C103"></i>&nbsp;{!$Label.ks_saved}</p>
                                </apex:outputPanel>
                            </div>
                        </div>
                    </apex:outputPanel>
                </div>
            </div>
            <apex:outputPanel id="scriptFormulario">
                <script type="text/javascript">
                //function callSortProductos() { sortProductos(); }
                $(document).ready(function(){
                    
                    $(".top4-KS").click(function(){
                        $(".fa-chevron-circle-up").toggleClass( "fa-rotate-180" );
                        $(".top3-KS").slideToggle( "slow");
                    });
                    
                    $('#checkall').click(function() {
                        if($(this).is(":checked"))
                        {
                            $('.checkline').attr( 'checked', 'checked' )
                        } else {
                            $('.checkline').removeAttr('checked');
                        }
                    });
                    
                    $('#warning-textarea-KS').change(function () {
                        if ($.trim($('#warning-textarea-KS').val()).length < 1) {
                            
                            $('.importar-KS').attr("disabled", true)
                            
                        } else {
                            
                            $('.importar-KS').attr("disabled", false)
                            
                        }
                    });
                    
                    $("input[class=import-KS]").click(function(){
                        $(".import-popup-KS").toggle( );
                        $(".import-popup-KS").find('textarea').focus();
                    });
                    $(".close-import-KS i, input[class=cancelar-KS]").click(function(){
                        $(".import-popup-KS").toggle( );
                        $(".import-popup-KS").find('textarea').blur();
                    });
                    
                    $('.add-KS').click(function() {  
                        
                        var NTimeRow = $('#addN').val();    
                        
                        for (i = 0; i < NTimeRow; i++) {
                            var structure = $('<tr><td><input type="checkbox" class="checkline" name="" value=""></td><td><input type="text" name="" class="" value=" "></td><td> </td><td></td><td><input type="text" name="" class="" value=" " style="width: 20px;"></td><td> </td><td> </td><td> </td><td><input type="text" name="" class="" value=" " style="width: 30px;"></td><td><input type="text" name="" class="" value=" " style="width: 40px;"></td><td><input type="text" name="" class="" value=" " style="width: 40px;"></td><td></td><td><input type="checkbox" name="" value=""></td><td><input type="checkbox" name="" value=""></td><td><select><option value=" "> </option><option value=" "> </option><option value=" "> </option><option value=" "> </option></select></td><td><input type="text" name="" class="" value="" style="width: 40px;"></td><td> </td><td><i class="fa fa-bars" aria-hidden="true" style="color: #999999;"></i></td></tr>');
                            $('.table-KS tbody').append(structure);
                        }
                        
                    });
                    
                    $('#tbody-KS').sortable({
                        scroll: true,
                        cursor: "ns-resize",
                        update: function( event, ui ) {
                            $('.orden').each(function(index) {
                                
                                var oldVal = $(this).prop('value');
                                $(this).prop('value', index);
                                
                                if (oldVal != index) {
                                    callRemoteSetCampo($(this).parent().find('.idLinea').prop('value'), 
                                                       'KS_Orden__c', 
                                                       '' + index);
                                }
                            });
                            //hiddenSaveLineas();
                            
                        }
                        //callSortProductos();
                    });
                    // ASIGNACIÓN DE PRODUCTO SELECCIONADO PARA BUSQUEDA DE VALORES (CON.COM.)
                    $('.select2-offscreen').each(function(){
                        $(this).change(function(){
                            $(".productoLookupDIV").find(":first-child").prop(
                                "value", 
                                $(this).parent().parent().children(".idUnico").prop('value'));
                            getProducto($(this).prop("value")); // $(".productoLookupDIV").find(":last-child").prop("value", idProducto);
                        });
                    });
                    
                    $('.select2-arrow').each(function(){
                        $(this).parent().mousedown(function(){
                            if ($(this).parent().hasClass('select2-dropdown-open')) {
                                var cod = $(this).parent().find('.select2-chosen').html();
                                if (cod != 'No value selected') {
                                    $(document).find('.select2-input').prop('value', cod);
                                }
                            }
                        });
                    });
                    
                    $(document).find('.select2-input').prop('autocapitalize', 'characters');
                    
                    $('.searchIcon-KS').each(function(){
                        $(this).hover(function(){
                            $(this).children("i").css("color", "#0061a4");
                        }, function() {
                            $( this ).children("i").css("color", "#999999");
                        });
                        $(this).click(function(){
                            $(".productoLookupDIV").find(":first-child").prop(
                                "value", $(this).parent().find(".orden").prop('value'));
                            selProducto();
                        });
                    });
                    
                    // Llamar a guardado tras venir del buscador
                    if ({!saveLinea}) { 
                        //saveLineas();
                        $(".productoLookupDIV").find(":first-child").prop("value", "{!oppLineToSave}");
                        $(".productoLookupDIV").find(":last-child").prop("value", "{!productoLookup}");
                        getDatosProducto();
                    }
                    
                    $(document).on("keydown", function (e) {
                        if (e.which == 8 && !$(e.target).is("input, textarea")) {
                            e.preventDefault();
                        }
                        if (e.which == 13 && $(e.target).is("input, textarea")) {
                            var whereTR = $(e.target).parent().parent().next();
                            if (whereTR.is("script")) { whereTR = $(whereTR).next(); }
                            if (whereTR.hasClass("rowLinea")) {
                                
                                var whereTD = $(whereTR).find(':first-child');
                                $(whereTD).find('.selectProd').focus();
                            }
                        }
                    });
                    
                    $('.select2-results').bind('DOMSubtreeModified', function(e) {
                        var ul = this;
                        $(this).children().each(function(index) {
                            
                            var li = this;
                            if($(this).prop('nodeName') && index == 0) {
                                $(this).prop('class', 'select2-no-results');
                            }
                        });
                    });
                    
                    $('.markit').focus(function() { 
                        $(this).css('outline', 'red dotted thick');
                    });
                    $('.markit').blur(function() { 
                        $(this).css('outline', '');
                    });

                    $('.prescritotodos').prop('checked', {!prescritGlobalValue});
                    $('.sincargotodos').prop('checked', {!sincargoGlobalValue});
                });
                function marcarTodos(checkput, className) {
                    var clase = '.'+className;
                    var ischecked = checkput.checked;
                    $(clase).each(function(index){
                        if (ischecked != this.checked) {
                            $(this).trigger( "click" );
                        }
                        $(this).prop('checked', ischecked);
                    });
                }
                function marcarGlobal(singleCheckN, globalCheckN) {
                    var claseS = '.'+singleCheckN;
                    var claseG = '.'+globalCheckN;
                    $(claseG).prop('checked', true);
                    $(claseS).each(function(){
                        var ischecked = this.checked;
                        if (!ischecked) { $(claseG).prop('checked', false); }
                    });
                }
                
                function setdescuento(inputDto, nameDto) {
                    var dto = $(inputDto).prop('value');
                    if (isNaN(dto.replace(",", "."))) {return;} // Si no es un número, fuera
                    $('.'+nameDto).each(function() {
                        //alert($(this).prop('value'));
                        if ($(this).prop('value')!=100 && $(this).prop('value')!="100,00") {
                            $(this).prop('value', dto.replace(".", ","));
                        }
                    });
                    $(inputDto).prop('value', '');
                    saveLineas();
                }
                
                function isDecimal(value) {
                    
                }
                
                function sinCargoCheck(checkput) {
                    
                    var isChecked = checkput.checked;
                    //alert($(checkput).parent().parent().find(".descuento"));
                    if (!isChecked) {
                        $(checkput).parent().parent().find(".descuento").each(function(){
                            $(this).show();
                            $(this).prop('readonly', false);      
                            $(this).val('');
                        });
                    }
                    
                }
                function sinCargo(select) {
                    
                    var selected = $(select).find(":selected").html();
                    var ischecked = selected!='--Ninguno--' && selected!='' && selected != null;
                    
                    var dist = false; var distInput;
                    var inst = false; var instInput;
                    var clfn = false; var clfnInput;
                    
                    //alert(ischecked);
                    $(select).parent().parent().parent().find(".descuento").each(function(){
                        
                        if ($(this).hasClass('dtoextra')) {
                            distInput = this;
                        } else if ($(this).hasClass('dtoinsta')) {
                            instInput = this;
                        } else if ($(this).hasClass('dtofinal')) {
                            clfnInput = this;
                        }
                        
                        var hasClass = false;
                        //alert(selected + ' =?= ' + $(this).attr('class'));
                        if ( selected == 'Distribuidor' && $(this).hasClass('dtoextra') ) { 
                            hasClass = true; dist = true;
                        }
                        if ( selected == 'Instalador' && $(this).hasClass('dtoinsta') ) { 
                            hasClass = true; inst = true;
                        }
                        if ( selected == 'Cliente final' && $(this).hasClass('dtofinal') ) { 
                            hasClass = true; clfn = true;
                        }
                        //alert( (ischecked&&hasClass) || !ischecked );
                    });
                    
                    if (dist&&ischecked) {
                        
                        $(distInput).val('100'); $(distInput).prop('readonly', true);
                        if ($(instInput).prop('readonly') == true) {
                            $(instInput).val(''); $(instInput).prop('readonly', false);
                        }
                        if ($(clfnInput).prop('readonly') == true) {
                            $(clfnInput).val(''); $(clfnInput).prop('readonly', false);
                        }            
                        
                    } else if (inst&&ischecked) {
                        
                        $(distInput).val('100'); $(distInput).prop('readonly', true);
                        $(instInput).val('100'); $(instInput).prop('readonly', true);
                        if ($(clfnInput).prop('readonly') == true) {
                            $(clfnInput).val(''); $(clfnInput).prop('readonly', false);
                        }            
                        
                    } else if (clfn&&ischecked) {
                        
                        $(distInput).val('100'); $(distInput).prop('readonly', true);
                        $(instInput).val('100'); $(instInput).prop('readonly', true);
                        $(clfnInput).val('100'); $(clfnInput).prop('readonly', true);
                        
                    } else if (!ischecked || (!dist&&!inst&&!clfn) ) {
                        
                        if ($(distInput).prop('readonly') == true) {
                            $(distInput).val(''); $(distInput).prop('readonly', false);
                        }
                        if ($(instInput).prop('readonly') == true) {
                            $(instInput).val(''); $(instInput).prop('readonly', false);
                        }
                        if ($(clfnInput).prop('readonly') == true) {
                            $(clfnInput).val(''); $(clfnInput).prop('readonly', false);
                        }
                    }
                }
                
                if ({!haveFocusLinea}) {
                    $('.{!focusLinea}_cantidad').focus();
                    $('.{!focusLinea}_cantidad').select();
                }
                </script>
            </apex:outputPanel>
        </apex:outputPanel>
    </apex:form>
</apex:page>